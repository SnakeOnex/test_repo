name: Sync to Public Repo

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout private repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        fetch-depth: 1 
    
    - name: Set up Git
      run: |
        git config --global user.name 'Aleš Kučera Bot'
        git config --global user.email 'kuceral4@fel.cvut.cz'
    
    - name: Remove sensitive files and folders
      run: |
        git rm -r --cached .github
        git rm -r --cached src/assignments_solution
        git commit -m "Remove private files and folders before sync"

    - name: Reset commit history
      run: |
        rm -rf .git
        git config --global init.defaultBranch main
        git init
        git remote add public https://github.com/urob-ctu/classification.git
        git add .
        git commit -m "Initial commit without history"

    - name: Force push to public repo using PAT
      env:
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}  # Use PAT for authentication
      run: |
        git push https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/urob-ctu/classification.git main --force

    # - name: Force push to public repo
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Use GITHUB_TOKEN for authentication
    #   run: |
    #     git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/urob-ctu/classification.git main --force
    
    # - name: Force push to public repo
    #   run: |
    #     git push public main --force
    #     #      env:
    #     #GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
